<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Buscador de Ejercicios de Física</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2em;
    }

    label,
    select,
    input {
      display: block;
      margin: 0.5em 0;
    }

    iframe {
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
      margin-top: 1em;
    }

    .resultado {
      margin-top: 1em;
      border-top: 1px solid #ccc;
      padding-top: 1em;
    }

    .item {
      margin-bottom: 2em;
    }
  </style>
</head>

<body>
  <h1>Buscador de Ejercicios de Física</h1>

  <label for="palabraClave">Búsqueda por palabra clave:</label>
  <input type="text" id="palabraClave" />

  <label for="tipo">Tipo:</label>
  <select id="tipo">
    <option value="">(cualquiera)</option>
    <option value="Planificación">Planificación</option>
    <option value="Guía">Guía</option>
    <option value="Ejercicios">Ejercicios</option>
  </select>

  <label for="nivel">Nivel:</label>
  <select id="nivel">
    <option value="">(cualquiera)</option>
    <option value="1° medio">1° medio</option>
    <option value="2° medio">2° medio</option>
    <option value="Electivo">Electivo</option>
    <option value="PAES">PAES</option>
  </select>

  <label for="tema">Tema:</label>
  <select id="tema">
    <option value="">(cualquiera)</option>
    <option value="Sonido">Sonido</option>
    <option value="Ondas">Ondas</option>
    <option value="MRU">MRU</option>
    <option value="MRUA">MRUA</option>
    <option value="Método Científico">Método Científico</option>
  </select>

  <label for="tipoEjercicio">Tipo de ejercicio:</label>
  <select id="tipoEjercicio">
    <option value="">(cualquiera)</option>
    <option value="Alternativas">Alternativas</option>
    <option value="Desarrollo">Desarrollo</option>
  </select>

  <label for="dificultad">Dificultad:</label>
  <select id="dificultad">
    <option value="">(cualquiera)</option>
    <option value="Elemental">Elemental</option>
    <option value="Medio">Medio</option>
    <option value="Avanzado">Avanzado</option>
  </select>

  <button onclick="filtrarEjercicios()">Buscar</button>

  <div id="resultados" class="resultado"></div>

  <script>
    const SHEET_ID = "1TpgF0ME-GmgpD8akfvhfezKlQ6aB3NHvWzuXozVLElU";
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

    let ejercicios = [];

    async function cargarEjerciciosDesdeSheet() {
      try {
        const response = await fetch(url);
        const text = await response.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const rows = json.table.rows;

        ejercicios = rows.map(row => {
          const c = row.c;
          return {
            titulo: c[0]?.v || '',
            tipo: c[1]?.v || '',
            nivel: c[2]?.v || '',
            tema: c[3]?.v || '',
            tipoEjercicio: c[4]?.v || '',
            dificultad: c[5]?.v || '',
            id: c[6]?.v || ''
          };
        });
      } catch (error) {
        console.error("Error cargando datos desde Google Sheets:", error);
        document.getElementById("resultados").innerHTML = "<p>Error al cargar los datos.</p>";
      }
    }

    function splitAndMatch(cellValue, filterValue) {
      return filterValue === "" || (cellValue && cellValue.split(",").map(s => s.trim()).includes(filterValue));
    }

    function filtrarEjercicios() {
      const palabraClave = document.getElementById("palabraClave").value.toLowerCase();
      const tipo = document.getElementById("tipo").value;
      const nivel = document.getElementById("nivel").value;
      const tema = document.getElementById("tema").value;
      const tipoEjercicio = document.getElementById("tipoEjercicio").value;
      const dificultad = document.getElementById("dificultad").value;

      const filtrados = ejercicios.filter(ej =>
        (palabraClave === "" || ej.titulo.toLowerCase().includes(palabraClave)) &&
        (tipo === "" || ej.tipo === tipo) &&
        splitAndMatch(ej.nivel, nivel) &&
        splitAndMatch(ej.tema, tema) &&
        (tipoEjercicio === "" || ej.tipoEjercicio === tipoEjercicio) &&
        (dificultad === "" || ej.dificultad === dificultad)
      );

      mostrarResultados(filtrados);
    }

    function mostrarResultados(lista) {
      const contenedor = document.getElementById("resultados");
      contenedor.innerHTML = "";

      if (lista.length === 0) {
        contenedor.innerHTML = "<p>No se encontraron resultados.</p>";
        return;
      }

      lista.forEach(ej => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <strong>${ej.titulo}</strong><br>
          Tipo: ${ej.tipo} | Nivel: ${ej.nivel} | Tema: ${ej.tema} | Tipo Ejercicio: ${ej.tipoEjercicio} | Dificultad: ${ej.dificultad}<br>
          ${ej.id ? `<iframe src="https://docs.google.com/document/d/${ej.id}/preview"></iframe>` : ''}
        `;
        contenedor.appendChild(div);
      });
    }

    window.onload = async () => {
      await cargarEjerciciosDesdeSheet();
    };
  </script>
</body>

</html>